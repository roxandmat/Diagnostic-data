<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnostic de maturit√© ‚Äî Predicta</title>
  <meta name="description" content="Questionnaire rapide pour √©valuer la maturit√© num√©rique et IA d'une entreprise industrielle (N1 √† N4) et obtenir des recommandations concr√®tes." />
  <style>
    :root{
      --bg-dark: #000; 
      --fg-dark: #f5f5f7;
      --muted-dark: #a1a1a6;
      --line-dark: #1c1c1e;
      --card-dark: rgba(255,255,255,0.06);
      --pill-dark: rgba(255,255,255,0.08);
      --glass-border-dark: rgba(255,255,255,0.12);

      --bg-light: #f5f5f7; 
      --fg-light: #000;
      --muted-light: #6b6b6f;
      --line-light: #d2d2d7;
      --card-light: rgba(255,255,255,0.9);
      --pill-light: rgba(0,0,0,0.06);
      --glass-border-light: rgba(0,0,0,0.1);

      --accent: #0a84ff;
      --accent-2: #34c759;
      --danger: #ff3b30;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg-dark);
      color:var(--fg-dark);
    }
    a{color:var(--accent);text-decoration:none}
    .container{max-width:1080px;margin:0 auto;padding:0 24px}
    .spacer-xl{height:64px}
    .spacer-l{height:40px}
    .spacer-m{height:24px}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:center;
      height:52px; border-bottom:1px solid var(--line-dark);
      backdrop-filter:saturate(180%) blur(14px);
      background:rgba(0,0,0,.6); color:var(--fg-dark);
    }
    .topbar .brand{display:flex;align-items:center;gap:10px;font-weight:600}
    .logo{
      width:18px;height:18px;border-radius:6px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, #bbb 20%, #222 55%), #111;
      box-shadow: 0 2px 8px rgba(0,0,0,.6) inset, 0 0 0 1px var(--glass-border-dark);
    }

    /* Sections altern√©es */
    .section{padding:72px 0}
    .section.dark{background: radial-gradient(1200px 600px at 50% -10%, #0a0a0a 20%, #000 60%); color:var(--fg-dark)}
    .section.light{background:var(--bg-light); color:var(--fg-light)}
    .section.light .muted{color:var(--muted-light)}
    .section.dark .muted{color:var(--muted-dark)}

    /* Hero */
    .hero{text-align:center}
    .eyebrow{font-weight:600; letter-spacing:.02em; font-size:14px}
    .section.dark .eyebrow{color:var(--muted-dark)}
    .section.light .eyebrow{color:var(--muted-light)}
    h1{
      margin:8px 0 10px; font-size:clamp(32px,6vw,64px);
      line-height:1.06; font-weight:700; letter-spacing:-.02em;
      background: linear-gradient(180deg, #fff, #cfcfd4 60%, #9c9ca3);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .sub{font-size:clamp(16px,2.4vw,20px)}
    .section.dark .sub{color:var(--muted-dark)}
    .section.light .sub{color:var(--muted-light)}
    .hero-cta{display:flex; gap:10px; justify-content:center; margin-top:18px}

    /* Pills */
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-size:14px
    }
    .section.dark .pill{background:var(--pill-dark); border:1px solid var(--glass-border-dark); color:#d8d8dc}
    .section.light .pill{background:var(--pill-light); border:1px solid var(--glass-border-light); color:#333}

    /* Cards */
    .card{border-radius:20px; padding:20px; box-shadow:0 10px 40px rgba(0,0,0,.12); backdrop-filter: blur(10px) saturate(120%)}
    .section.dark .card{border:1px solid var(--glass-border-dark); background:var(--card-dark)}
    .section.light .card{border:1px solid var(--glass-border-light); background:var(--card-light)}

    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:980px){ .grid{grid-template-columns:1.2fr .8fr} }

    .divider{height:1px; margin:16px 0}
    .section.dark .divider{background:linear-gradient(90deg, transparent, var(--line-dark), transparent)}
    .section.light .divider{background:linear-gradient(90deg, transparent, var(--line-light), transparent)}

    /* Progress */
    .progress{height:10px; border-radius:999px; overflow:hidden; min-width:220px}
    .section.dark .progress{background:#0b0b0c; border:1px solid var(--line-dark)}
    .section.light .progress{background:#e9e9ed; border:1px solid var(--line-light)}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,#007aff,#0bd3d3); transition:width .35s ease}

    /* Tags / Questions */
    .tag{font-size:12px; border-radius:999px; padding:4px 10px}
    .section.dark .tag{color:#cfd0d4; background:var(--pill-dark); border:1px solid var(--glass-border-dark)}
    .section.light .tag{color:#333; background:var(--pill-light); border:1px solid var(--glass-border-light)}
    .chips{display:flex;flex-wrap:wrap;gap:8px}

    .q{padding:16px; border-radius:16px}
    .section.dark .q{background:rgba(255,255,255,0.04); border:1px solid var(--glass-border-dark)}
    .section.light .q{background:#fff; border:1px solid var(--line-light)}
    .q h3{margin:0 0 8px; font-size:18px; letter-spacing:-.01em}
    .section.dark .q small{color:var(--muted-dark)}
    .section.light .q small{color:var(--muted-light)}
    .scale{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

    .btn{
      cursor:pointer; border:none; border-radius:12px; padding:10px 12px;
      transition: transform .06s ease, filter .15s ease, border-color .15s ease;
    }
    .section.dark .btn{background:rgba(255,255,255,0.06); color:#e9e9ec; border:1px solid var(--glass-border-dark)}
    .section.light .btn{background:#f4f4f6; color:#111; border:1px solid var(--line-light)}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform: translateY(1px)}
    .section.dark .btn[aria-pressed="true"]{
      color:#eafff0; background:linear-gradient(180deg, rgba(52,199,89,.25), rgba(0,0,0,.1)); border-color:rgba(52,199,89,.55);
      box-shadow:0 0 0 1px rgba(52,199,89,.35) inset;
    }
    .section.light .btn[aria-pressed="true"]{
      color:#073b16; background:linear-gradient(180deg, rgba(52,199,89,.18), rgba(0,0,0,0)); border-color:rgba(52,199,89,.45);
      box-shadow:0 0 0 1px rgba(52,199,89,.25) inset;
    }

    /* Actions */
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .cta,.ghost{cursor:pointer; border:none; border-radius:999px; padding:12px 18px; font-weight:600; transition: transform .06s ease, filter .2s ease;}
    .cta{background:linear-gradient(180deg,#0a84ff,#0066cc); color:white; border:1px solid #0a84ff}
    .ghost{background:transparent}
    .section.dark .ghost{color:#e5e5ea; border:1px solid var(--glass-border-dark); background:var(--pill-dark)}
    .section.light .ghost{color:#111; border:1px solid var(--glass-border-light); background:var(--pill-light)}
    .cta:hover,.ghost:hover{filter:brightness(1.05)}
    .cta:active,.ghost:active{transform:translateY(1px)}

    /* R√©sultats */
    .result{display:none}
    .score-badge{display:inline-flex; gap:10px; align-items:center; padding:10px 14px; border-radius:14px}
    .section.dark .score-badge{background:rgba(255,255,255,0.04); border:1px solid var(--glass-border-dark)}
    .section.light .score-badge{background:#fff; border:1px solid var(--line-light)}
    .score-badge strong{font-size:24px; letter-spacing:-.02em}
    .lvl{font-weight:700; color:#2b9d42}

    .bars{display:grid;gap:10px;margin-top:14px}
    .barrow{display:grid;grid-template-columns:200px 1fr; align-items:center;gap:10px}
    .barx{height:10px;border-radius:999px;overflow:hidden}
    .section.dark .barx{background:#0b0b0c; border:1px solid var(--line-dark)}
    .section.light .barx{background:#e9e9ed; border:1px solid var(--line-light)}
    .fill{height:100%;background:linear-gradient(90deg,#0bd3d3,#0a84ff);width:0%}

    /* Footer */
    footer.sticky{
      position:fixed; inset:auto 0 0 0; 
      background:rgba(0,0,0,.85); color:var(--fg-dark);
      border-top:1px solid var(--line-dark); backdrop-filter: blur(10px);
    }
    .foot{max-width:1080px;margin:0 auto;padding:12px 24px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .foot .note{color:var(--muted-dark); font-size:14px}

    /* Reveal doux */
    .reveal{opacity:0; transform:translateY(12px); transition:opacity .5s ease, transform .5s ease}
    .reveal.in{opacity:1; transform:none}

    /* Champs d'identification */
    .form{display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px}
    @media(min-width:980px){ .form{grid-template-columns:1fr 1fr 1fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:14px}
    .section.light .field label{color:var(--muted-light)}
    .section.dark .field label{color:var(--muted-dark)}
    .input{
      width:100%; border-radius:12px; padding:10px 12px; font-size:14px;
      border:1px solid; outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .section.light .input{background:#fff; border-color:var(--line-light); color:#111}
    .section.dark .input{background:rgba(255,255,255,.06); border-color:var(--glass-border-dark); color:#f5f5f7}
    .input:focus{box-shadow:0 0 0 2px rgba(10,132,255,.25); border-color:#0a84ff}
    .help{font-size:12px}
    .section.light .help{color:var(--muted-light)}
    .section.dark .help{color:var(--muted-dark)}

    /* Erreurs */
    .error .input{
      border-color: rgba(255,59,48,.8) !important;
      box-shadow: 0 0 0 2px rgba(255,59,48,.2);
    }
    .error-msg{font-size:12px; color:var(--danger);}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="brand"><div class="logo" aria-hidden="true"></div> Diagnostic Predicta</div>
  </div>

  <!-- Section sombre (Hero) -->
  <section class="section dark">
    <header class="hero container">
      <div class="eyebrow muted">√âvaluation express</div>
      <h1>Diagnostic de maturit√©<br>num√©rique&nbsp;&amp;&nbsp;IA ‚Äî Industrie</h1>
      <p class="sub">Mesurez votre niveau (N1 ‚Üí N4) et repartez avec des recommandations claires et prioris√©es.</p>
      <div class="hero-cta">
        <span class="pill">‚è±Ô∏è 5&nbsp;min</span>
        <span class="pill">üß™ POC ‚Üí Produit</span>
      </div>
    </header>
  </section>

  <!-- Section claire (Questions + Champs) -->
  <section class="section light">
    <main class="container">
      <div class="card reveal">
        <div style="display:flex;align-items:center;gap:14px;justify-content:space-between;flex-wrap:wrap">
          <div class="chips">
            <span class="tag">Vision & Gouvernance</span>
            <span class="tag">Donn√©es & IT</span>
            <span class="tag">Production & Automatisation</span>
            <span class="tag">Qualit√© & Vision</span>
            <span class="tag">IA & Analytics</span>
            <span class="tag">Organisation & Comp√©tences</span>
          </div>
          <div class="progress"><div class="bar" id="progress"></div></div>
        </div>

        <!-- Champs d'identification -->
        <div class="form" id="identity">
          <div class="field" id="companyField">
            <label for="company">Nom de l'entreprise <span aria-hidden="true" style="color:#888">*</span></label>
            <input class="input" type="text" id="company" name="company" placeholder="Ex. Dupont Industries" autocomplete="organization" aria-required="true" aria-invalid="false">
            <span class="error-msg" id="companyError"></span>
          </div>
          <div class="field" id="sectorField">
            <label for="sector">Secteur d'activit√©</label>
            <input class="input" type="text" id="sector" name="sector" placeholder="Ex. A√©ronautique, Agroalimentaire, etc.">
          </div>
          <div class="field" id="emailField">
            <label for="email">Adresse email</label>
            <input class="input" type="email" id="email" name="email" placeholder="nom@entreprise.fr" autocomplete="email" aria-invalid="false">
            <span class="help">Facultative. Si renseign√©e, elle doit √™tre valide.</span>
            <span class="error-msg" id="emailError"></span>
          </div>
          <!-- Consentement pour l'email de confirmation -->
          <div class="field" style="grid-column: 1 / -1;">
            <label style="display:flex;gap:8px;align-items:center">
              <input type="checkbox" id="send_copy">
              M‚Äôenvoyer une copie de mes r√©ponses par email
            </label>
            <small class="help">En cochant, vous recevrez un r√©capitulatif √† l‚Äôadresse indiqu√©e.</small>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <!-- Colonne questions -->
          <section>
            <div id="questions" style="margin-top:6px;display:grid;gap:12px"></div>
            <div class="spacer-m"></div>
            <div class="actions">
              <button class="cta" id="compute">Calculer mon niveau et envoyer mes r√©ponses</button>
              <button class="ghost" id="reset">R√©initialiser</button>
              <button class="ghost" id="export">Exporter le r√©sultat (JSON)</button>
              <button class="ghost" id="print">Imprimer / PDF</button>
            </div>
          </section>

          <!-- Colonne r√©sultats -->
          <aside class="result" id="result">
            <div class="score-badge">
              <span>Score global</span>
              <strong id="score">0%</strong>
            </div>
            <div style="margin-top:6px">üìä <span id="level" class="lvl">N/A</span></div>

            <div class="bars" id="catbars"></div>

            <div style="margin-top:16px">
              <h3 style="margin:0 0 8px">Recommandations prioritaires</h3>
              <ol id="reco" style="margin:0 0 8px 18px;line-height:1.6"></ol>
              <small class="muted">Ces recommandations sont g√©n√©r√©es en fonction de vos r√©ponses.</small>
            </div>
          </aside>
        </div>
      </div>
    </main>
  </section>

  <!-- Section sombre (R√©sum√©/CTA final) -->
  <section class="section dark">
    <div class="container">
      <div class="card reveal" style="text-align:center">
        <h2 style="margin:0 0 10px; font-size:clamp(24px,4vw,36px); letter-spacing:-.02em;">Passez de l‚Äôintuition au pilotage</h2>
        <p class="muted" style="margin:0 0 16px">Identifiez vos priorit√©s et planifiez vos prochains d√©ploiements digitaux.</p>
        <div class="actions" style="justify-content:center">
          <button class="cta" id="quickDone">Voir un exemple rempli</button>
          <button class="ghost" id="print2">Imprimer / PDF</button>
        </div>
      </div>
    </div>
  </section>

  <footer class="sticky">
    <div class="foot">
      <div class="note">üí° 0 = pas en place ‚Üí 3 = compl√®tement. Niveaux : N1 (Analogique), N2 (Automatis√©), N3 (Connect√©), N4 (Smart Factory).</div>
      <div class="actions">
        <button class="cta" id="quickDone_footer">Exemple rempli</button>
      </div>
    </div>
  </footer>

  <script>
    /* ==== Scroll helpers ==== */
    function scrollToTop(force=false){
      const el = document.scrollingElement || document.documentElement || document.body;
      try{ el.scrollTo({top:0, behavior: force ? 'auto' : 'smooth'}); }catch(_){ el.scrollTop = 0; }
      document.documentElement.scrollTop = 0; document.body.scrollTop = 0;
    }
    function scrollToField(el){
      if(!el) return;
      try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(_){ el.focus(); }
      el.focus({preventScroll:true});
    }

    /* ==== Reveal ==== */
    const io = new IntersectionObserver((es)=>es.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('in'); }), {threshold:.1});
    document.querySelectorAll('.reveal').forEach(n=>io.observe(n));

    /* ==== Validation identit√© ==== */
    const companyEl = document.getElementById('company');
    const emailEl   = document.getElementById('email');
    const companyField = document.getElementById('companyField');
    const emailField   = document.getElementById('emailField');
    const companyError = document.getElementById('companyError');
    const emailError   = document.getElementById('emailError');

    function isValidEmail(v){
      if(!v) return true; // facultatif
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
      return re.test(v.trim());
    }

    function clearErrors(){
      [companyField, emailField].forEach(f=>f.classList.remove('error'));
      companyEl.setAttribute('aria-invalid','false');
      emailEl.setAttribute('aria-invalid','false');
      companyError.textContent = '';
      emailError.textContent = '';
    }

    function validateIdentity(){
      clearErrors();
      let ok = true;

      if(!companyEl.value.trim()){
        ok = false;
        companyField.classList.add('error');
        companyEl.setAttribute('aria-invalid','true');
        companyError.textContent = "Le nom de l'entreprise est requis.";
      }

      if(!isValidEmail(emailEl.value)){
        ok = false;
        emailField.classList.add('error');
        emailEl.setAttribute('aria-invalid','true');
        emailError.textContent = "Format d'email invalide (ex. nom@entreprise.fr).";
      }

      if(!ok){
        const firstError = document.querySelector('.error .input');
        scrollToField(firstError);
      }
      return ok;
    }

    // Efface l'erreur en live
    [companyEl, emailEl].forEach(inp=>{
      inp.addEventListener('input', ()=> {
        if(inp === companyEl && companyEl.value.trim()){
          companyField.classList.remove('error');
          companyEl.setAttribute('aria-invalid','false');
          companyError.textContent = '';
        }
        if(inp === emailEl && isValidEmail(emailEl.value)){
          emailField.classList.remove('error');
          emailEl.setAttribute('aria-invalid','false');
          emailError.textContent = '';
        }
      });
    });

    /* ==== Mod√®le ==== */
    const CATEGORIES = [
      { key:'gov', label:'Vision & Gouvernance', weight:1 },
      { key:'it', label:'Donn√©es & IT', weight:1 },
      { key:'prod', label:'Production & Automatisation', weight:1 },
      { key:'qual', label:'Qualit√© & Vision', weight:1 },
      { key:'ml', label:'IA & Analytics', weight:1 },
      { key:'org', label:'Organisation & Comp√©tences', weight:1 }
    ];

    const QUESTIONS = [
      { cat:'gov', text:"Une feuille de route de mise en place de maintenance pr√©dictive assist√©e par IA est formalis√©e (objectifs, KPI, budget)." },
      { cat:'gov', text:"La direction sponsorise activement les projets digitaux/IA." },
      { cat:'it', text:"Nous disposons d'un r√©seau stable (LAN industriel) et d'une politique de sauvegarde des donn√©es." },
      { cat:'it', text:"Les donn√©es de production sont historis√©es et consultables (MES/SCADA/DB)." },
      { cat:'prod', text:"Les postes de production sont instrument√©s (capteurs, PLC) et interfa√ßables (API/OPC/MQTT)." },
      { cat:'prod', text:"Les changements de s√©rie (changeover) et pannes/d√©fauts sont standardis√©s et document√©s." },
      { cat:'qual', text:"Un contr√¥le qualit√© automatis√© (cam√©ra ou capteurs) est d√©j√† en place sur les lignes de production." },
      { cat:'qual', text:"Des indicateurs qualit√©s sont mis en place, suivis et partag√©s." },
      { cat:'ml', text:"Nous avons des cas d‚Äôusage IA (vision, d√©tection d√©faut, optimisation) en production ou pilote." },
      { cat:'ml', text:"Si oui, un processus d'am√©lioration continue des mod√®les (r√©-entra√Ænement) existe." },
      { cat:'org', text:"Les op√©rateurs sont form√©s aux outils digitaux, avec proc√©dures simples (SOP)." },
      { cat:'org', text:"Un r√©f√©rent interne (qualit√©/automatisme/IT) pilote les projets digitaux." }
    ];

    const SCALE = [
      { v:0, label:'0 ‚Äî Pas du tout' },
      { v:1, label:'1 ‚Äî En r√©flexion' },
      { v:2, label:'2 ‚Äî Partiellement' },
      { v:3, label:'3 ‚Äî Compl√®tement' }
    ];

    const qEl = document.getElementById('questions');

    // Render questions
    QUESTIONS.forEach((q, idx)=>{
      const el = document.createElement('div');
      el.className = 'q';
      el.innerHTML = `
        <h3>Q${idx+1}. ${q.text}</h3>
        <div class="scale" role="group" aria-label="√âchelle de maturit√©">
          ${SCALE.map(s=>`<button class='btn' data-q='${idx}' data-v='${s.v}' aria-pressed='false' title='${s.label}'>${s.v}</button>`).join('')}
        </div>
        <small>${SCALE.map(s=>s.label).join(' ¬∑ ')}</small>
      `;
      qEl.appendChild(el);
    });

    const answers = Array(QUESTIONS.length).fill(null);

    // Interactions boutons √©chelle
    qEl.addEventListener('click', (e)=>{
      const b = e.target.closest('button.btn');
      if(!b) return;
      const id = +b.dataset.q, val = +b.dataset.v;
      answers[id] = val;
      b.parentElement.querySelectorAll('button').forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      updateProgress();
    });

    function updateProgress(){
      const done = answers.filter(v=>v!==null).length;
      const pct = Math.round((done / answers.length) * 100);
      document.getElementById('progress').style.width = pct + '%';
    }

    /* ==== Recos Predicta ==== */
    function buildRecoPredicta(global, lowCats) {
      const company = (document.getElementById('company')?.value || '').trim();
      const sector  = (document.getElementById('sector')?.value || '').trim();
      const who = company ? ` pour ${company}` : '';
      const inSector = sector ? ` (${sector})` : '';
      const reco = [];

      // Cap g√©n√©ral
      if (global < 50) {
        reco.push(
          `Atelier de cadrage 2h${who}${inSector} : objectifs, p√©rim√®tre pilotes et ROI cible.`,
          `POC rapide sur 1 ligne (‚â§ 6 semaines) : mesure d‚Äôimpact et plan d‚Äôindustrialisation.`
        );
      } else {
        reco.push(
          `Roadmap 90 jours${who} : d√©ploiement multi-lignes, standardisation et gouvernance.`,
          `Kit de d√©ploiement (Edge + monitoring) : r√©plication scalable site ‚Üí site.`
        );
      }

      // Ciblage sur cat√©gories faibles
      lowCats.forEach(c=>{
        if(c.key==='it'){
          reco.push(
            `Audit √©clair IT/OT : r√©seau usine, sauvegardes, s√©curit√© ; socle donn√©es (DB/MQTT/OPC-UA).`,
            `Mise en place du bus de donn√©es & historique production (connecteurs pr√™ts √† l‚Äôemploi).`
          );
        } else if(c.key==='qual'){
          reco.push(
            `Poste de vision pilot√© : cam√©ra, √©clairage, annotation et m√©triques (NOK/scrap/FP/FN).`,
            `Table de validation ‚Äúgolden set‚Äù et suivi des performances en routine.`
          );
        } else if(c.key==='ml'){
          reco.push(
            `Pipeline MLOps${inSector} : entra√Ænement, versionning mod√®les/datasets, r√©-apprentissage continu.`,
            `Mise en prod d√©tection/optimisation avec supervision et alertes.`
          );
        } else if(c.key==='prod'){
          reco.push(
            `Standardisation changeovers & exposition signaux (API/OPC/MQTT) pour OEE temps-r√©el.`,
            `Tableaux de bord op√©rateurs (poste/ligne) et alertes √©cart de proc√©d√©.`
          );
        } else if(c.key==='gov'){
          reco.push(
            `PMO data/IA${who} : sponsoring, KPI (scrap, TRS), comit√©s mensuels, gestion des risques.`,
            `Mod√®le de valeur : cas d‚Äôusage prioris√©s (effet EBITDA, capex/opex, payback).`
          );
        } else if(c.key==='org'){
          reco.push(
            `Acculturation & formation cibl√©e : op√©rateurs, qualit√©, maintenance (SOP et runbooks).`,
            `Bin√¥me champion (qualit√© + automatisme) et routines d‚Äôam√©lioration continue.`
          );
        }
      });

      // D√©duplique
      return Array.from(new Set(reco));
    }

    // Compute score & recommendations
    function compute(){
      // Validation identit√© avant calcul
      if(!validateIdentity()) return;

      const unanswered = answers.reduce((acc,v,i)=> (v===null? acc.concat(i+1):acc), []);
      if(unanswered.length){
        if(!confirm(`Vous n\'avez pas r√©pondu √† ${unanswered.length} question(s). Calculer quand m√™me ?`)) return;
      }

      const catMap = Object.fromEntries(CATEGORIES.map(c=>[c.key,{sum:0,count:0}]));
      QUESTIONS.forEach((q,i)=>{
        const v = (answers[i] ?? 0);
        catMap[q.cat].sum += v;
        catMap[q.cat].count += 1;
      });

      const catScores = CATEGORIES.map(c=>{
        const {sum,count} = catMap[c.key];
        const pct = Math.round((sum/(count*3))*100);
        return { key:c.key, label:c.label, pct };
      });

      const global = Math.round(catScores.reduce((a,c)=>a+c.pct,0)/catScores.length);

      const level = global>=76? 'N4 ‚Äî Smart Factory'
                 : global>=51? 'N3 ‚Äî Connect√©'
                 : global>=26? 'N2 ‚Äî Automatis√©'
                 : 'N1 ‚Äî Analogique';

      // Recos Predicta
      const low = [...catScores].sort((a,b)=>a.pct-b.pct).slice(0,2);
      const reco = buildRecoPredicta(global, low);

      showResult({global, level, catScores, reco});
    }

    function showResult({global, level, catScores, reco}){
      const result = document.getElementById('result');
      result.style.display = 'block';
      document.getElementById('score').textContent = global + '%';
      document.getElementById('level').textContent = level;

      const wrap = document.getElementById('catbars');
      wrap.innerHTML = '';
      catScores.forEach(c=>{
        const row = document.createElement('div');
        row.className = 'barrow';
        row.innerHTML = `
          <div>${c.label}</div>
          <div class='barx'><div class='fill' style='width:${c.pct}%'></div></div>
        `;
        wrap.appendChild(row);
      });

      const list = document.getElementById('reco');
      list.innerHTML='';
      reco.forEach(r=>{
        const li = document.createElement('li');
        li.textContent = r;
        list.appendChild(li);
      });

      // Scroll en haut apr√®s rendu
      requestAnimationFrame(()=>requestAnimationFrame(()=>scrollToTop(false)));
    }

    // Export JSON (inclut les champs)
    function exportJSON(){
      const meta = {
        company: document.getElementById('company')?.value?.trim() || '',
        sector:  document.getElementById('sector')?.value?.trim() || '',
        email:   document.getElementById('email')?.value?.trim() || ''
      };
      const data = { ts: new Date().toISOString(), meta, answers };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'diagnostic_maturite.json'; a.click();
      URL.revokeObjectURL(url);
    }
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyNp7KNEIkxxOzSAHtt6DZKk3pysIsMs5g4HA-OvW9Ga6hDMrlQ7buz9dGYxwOOCiP0OQ/exec"; // <-- ton URL Web App
    const SHARED_SECRET   = "predicta"; // <-- doit matcher le code Apps Script


    async function sendResults(payload){
      const meta = {
        company: document.getElementById('company')?.value?.trim() || '',
        sector:  document.getElementById('sector')?.value?.trim() || '',
        email:   document.getElementById('email')?.value?.trim() || '',
        consent: !!document.getElementById('send_copy')?.checked
      };

      const body = {
        secret: SHARED_SECRET,
        meta,
        result: {
          global: payload.global,
          level: payload.level,
          catScores: payload.catScores,
          reco: payload.reco
        }
      };

      try{
        const res = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" }, // √©vite le preflight CORS
          body: JSON.stringify(body)
        });

        // La r√©ponse peut √™tre "opaque", on tente quand m√™me:
        let ok = false;
        try {
          const data = await res.json();
          ok = !!data?.ok;
          if (!ok) console.warn('Apps Script responded:', data);
        } catch(_){
          ok = res.ok;
        }
        alert(ok ? "‚úÖ R√©ponses envoy√©es" : "‚ö†Ô∏è Soumission envoy√©e (v√©rifie le Sheet / ta bo√Æte mail)");
      }catch(err){
        console.error(err);
        alert("‚ùå Envoi impossible (r√©seau).");
      }
    }

    // üëâ Le hook DOIT √™tre au niveau racine (pas dans sendResults)
    const __origShowResult = showResult;
    showResult = function(payload){
      __origShowResult(payload);
      sendResults(payload);
    };

    // Quick demo fill
    function quickFill(){
      const pattern = [2,1, 2,1, 2,2, 1,2, 1,1, 2,2];
      pattern.forEach((v,i)=>{
        answers[i]=v;
        const group = qEl.children[i].querySelector('.scale');
        group.querySelectorAll('button').forEach(btn=>{
          btn.setAttribute('aria-pressed', btn.dataset.v == v ? 'true':'false');
        });
      });
      updateProgress();
      compute();
    }

    // Reset doux
    function resetAll(){
      answers.fill(null);
      qEl.querySelectorAll('.scale').forEach(group=>{
        group.querySelectorAll('button').forEach(btn=>btn.setAttribute('aria-pressed','false'));
      });
      document.getElementById('progress').style.width = '0%';
      document.getElementById('result').style.display = 'none';
      ['company','sector','email'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
      clearErrors();
      scrollToTop(true);
    }

    // Buttons
    document.getElementById('compute').addEventListener('click', compute);
    document.getElementById('reset').addEventListener('click', resetAll);
    document.getElementById('export').addEventListener('click', exportJSON);
    document.getElementById('print').addEventListener('click', ()=>window.print());
    document.getElementById('print2')?.addEventListener('click', ()=>window.print());
    document.getElementById('quickDone').addEventListener('click', quickFill);
    document.getElementById('quickDone_footer').addEventListener('click', quickFill);
    /* === jusqu'ici === */
  </script>
</body>
</html>



